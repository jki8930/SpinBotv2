<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRGSpin</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-pink-100">
    <div id="app" class="p-4">
        <div class="flex justify-between items-center mb-4">
            <div>
                <span class="font-bold">–ë–∞–ª–∞–Ω—Å:</span> <span id="balance">0</span>
            </div>
            <div>
                <span class="font-bold">–¢–∏–∫–µ—Ç—ã:</span> <span id="tickets">0</span>
            </div>
        </div>
        <div id="next-ticket-timer" class="hidden text-center text-gray-500 mb-4">
            –°–ª–µ–¥—É—é—â–∏–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∏–∫–µ—Ç —á–µ—Ä–µ–∑: <span id="timer"></span>
        </div>
        <div class="flex border-b">
            <button class="px-4 py-2 -mb-px font-semibold text-gray-800 border-b-2 border-pink-500" data-tab="wheel">üé∞ –ö–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã</button>
            <button class="px-4 py-2 font-semibold text-gray-500" data-tab="leaderboard">üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</button>
            <button class="px-4 py-2 font-semibold text-gray-500" data-tab="referrals">üë• –†–µ—Ñ–µ—Ä–∞–ª—ã</button>
        </div>
        <div id="wheel" class="py-4">
            <div class="flex flex-col items-center">
                <div id="wheel-container" class="w-64 h-64 rounded-full flex items-center justify-center mb-4 relative">
                    <!-- Sectors will be generated here -->
                </div>
                <button id="spin-button" class="px-6 py-2 bg-pink-500 text-white font-bold rounded-full">–í—Ä–∞—â–∞—Ç—å</button>
            </div>
        </div>
        <div id="leaderboard" class="hidden py-4">
            <h2 class="text-2xl font-bold mb-4">–¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h2>
            <table class="w-full text-left">
                <thead>
                    <tr>
                        <th class="pb-2">–ò–≥—Ä–æ–∫</th>
                        <th class="pb-2">–ë–∞–ª–∞–Ω—Å</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <!-- Leaderboard data will be inserted here -->
                </tbody>
            </table>
        </div>
        <div id="referrals" class="hidden py-4">
            <h2 class="text-2xl font-bold mb-4">–í–∞—à–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã</h2>
            <table class="w-full text-left">
                <thead>
                    <tr>
                        <th class="pb-2">–ò–≥—Ä–æ–∫</th>
                    </tr>
                </thead>
                <tbody id="referrals-body">
                    <!-- Referrals data will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>
    <script>
        const tabs = document.querySelectorAll('[data-tab]');
        const tabContents = document.querySelectorAll('[id^="wheel"], [id^="leaderboard"], [id^="referrals"]');
        const balanceElement = document.getElementById('balance');
        const ticketsElement = document.getElementById('tickets');
        const nextTicketTimerElement = document.getElementById('next-ticket-timer');
        const timerElement = document.getElementById('timer');
        const wheelContainer = document.getElementById('wheel-container');
        const spinButton = document.getElementById('spin-button');
        const leaderboardBody = document.getElementById('leaderboard-body');
        const referralsBody = document.getElementById('referrals-body');

        let prizes = [];
        let user = { telegram_id: 123 }; // Placeholder for user data

        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.telegram_id === user.telegram_id) {
                updateUserData();
            }
            if (document.getElementById('leaderboard').classList.contains('hidden') === false) {
                fetchLeaderboard();
            }
        };

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('border-pink-500', 'text-gray-800'));
                tab.classList.add('border-pink-500', 'text-gray-800');

                tabContents.forEach(content => {
                    if (content.id === tab.dataset.tab) {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                });

                if (tab.dataset.tab === 'leaderboard') {
                    fetchLeaderboard();
                } else if (tab.dataset.tab === 'referrals') {
                    fetchReferrals();
                }
            });
        });

        async function updateUserData() {
            const response = await fetch(`/api/users/${user.telegram_id}`);
            const userData = await response.json();
            balanceElement.textContent = userData.balance;
            ticketsElement.textContent = userData.tickets;

            if (userData.tickets === 0) {
                nextTicketTimerElement.classList.remove('hidden');
                startTimer();
            } else {
                nextTicketTimerElement.classList.add('hidden');
            }
        }

        async function startTimer() {
            const response = await fetch(`/api/wheel/ticket-status/${user.telegram_id}`);
            const data = await response.json();
            let seconds = data.next_free_ticket_in;

            const interval = setInterval(() => {
                seconds--;
                const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
                const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
                const s = Math.floor(seconds % 60).toString().padStart(2, '0');
                timerElement.textContent = `${h}:${m}:${s}`;

                if (seconds <= 0) {
                    clearInterval(interval);
                    updateUserData();
                }
            }, 1000);
        }

        async function fetchPrizes() {
            const response = await fetch('/api/wheel/prizes');
            prizes = await response.json();
            createWheel();
        }

        function createWheel() {
            wheelContainer.innerHTML = '';
            const totalChance = prizes.reduce((acc, prize) => acc + prize.chance, 0);
            let currentAngle = 0;
            const gradientColors = [];

            prizes.forEach((prize, index) => {
                const prizeAngle = (prize.chance / totalChance) * 360;
                const color = index % 2 === 0 ? '#fce7f3' : '#fbcfe8';
                gradientColors.push(`${color} ${currentAngle}deg ${currentAngle + prizeAngle}deg`);

                const prizeElement = document.createElement('div');
                prizeElement.className = 'absolute w-full h-full';
                prizeElement.style.transform = `rotate(${currentAngle + prizeAngle / 2}deg)`;
                prizeElement.innerHTML = `<span class="absolute top-0 left-1/2 -translate-x-1/2 text-xs">${prize.name}</span>`;
                wheelContainer.appendChild(prizeElement);

                currentAngle += prizeAngle;
            });

            wheelContainer.style.background = `conic-gradient(${gradientColors.join(', ')})`;
        }

        spinButton.addEventListener('click', async () => {
            if (parseInt(ticketsElement.textContent) <= 0) {
                alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–∏–∫–µ—Ç–æ–≤!");
                return;
            }

            const response = await fetch(`/api/wheel/spin/${user.telegram_id}`, { method: 'POST' });
            if (response.status !== 200) {
                const error = await response.json();
                alert(error.detail);
                return;
            }
            const winningPrize = await response.json();

            const totalChance = prizes.reduce((acc, prize) => acc + prize.chance, 0);
            const prizeAngle = (winningPrize.chance / totalChance) * 360;
            const winningAngle = 360 - (prizes.findIndex(p => p.id === winningPrize.id) * prizeAngle + prizeAngle / 2);

            wheelContainer.style.transition = 'transform 3s ease-out';
            wheelContainer.style.transform = `rotate(${360 * 5 + winningAngle}deg)`;

            setTimeout(() => {
                alert(`–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏: ${winningPrize.name}`);
                wheelContainer.style.transition = 'none';
                wheelContainer.style.transform = `rotate(${winningAngle}deg)`;
                updateUserData();
            }, 3000);
        });

        async function fetchLeaderboard() {
            const response = await fetch('/api/users/top');
            const users = await response.json();
            leaderboardBody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2">${user.username || 'Anonymous'}</td>
                    <td>${user.balance}</td>
                `;
                leaderboardBody.appendChild(row);
            });
        }

        async function fetchReferrals() {
            const response = await fetch(`/api/users/${user.telegram_id}/referrals`);
            const referrals = await response.json();
            referralsBody.innerHTML = '';
            referrals.forEach(referral => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2">${referral.username || 'Anonymous'}</td>
                `;
                referralsBody.appendChild(row);
            });
        }

        updateUserData();
        fetchPrizes();
    </script>
</body>
</html>